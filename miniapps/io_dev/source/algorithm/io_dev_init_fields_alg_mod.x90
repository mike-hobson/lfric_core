!-----------------------------------------------------------------------------
! (C) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!>@brief Initialises IO_Dev fields to the default analytic value - the product
!>       of the x, y and z coordinate fields for any given function space
module io_dev_init_fields_alg_mod

  use field_mod,                       only : field_type
  use field_parent_mod,                only : field_parent_type
  use field_collection_mod,            only : field_collection_type, &
                                              field_collection_iterator_type
  use io_dev_init_kernel_mod,          only : io_dev_init_kernel_type

  implicit none

  private
  public :: io_dev_init_fields_alg

contains
  !> @details An algorithm for initialising IO_Dev fields analytically
  !> @param[inout] core_fields The core model field collection
  !> @param[in]    chi_xyz     A size 3 array of fields holding the mesh
  !>                           (X,Y,Z) coordinates
subroutine io_dev_init_fields_alg(core_fields, chi_xyz)

    implicit none

    type(field_collection_type), intent(inout) :: core_fields
    type(field_type),            intent(in)    :: chi_xyz(3)

    type(field_collection_iterator_type) :: iter

    class(field_parent_type), pointer :: fld => null()

    iter = core_fields%get_iterator()
    do
      if ( .not.iter%has_next() ) exit
      fld => iter%next()
      select type(fld)
        type is (field_type)

        ! Initialise fields to default analytic value (product of x, y and z
        ! coordinates)
        call invoke ( io_dev_init_kernel_type(fld, chi_xyz) )

      end select
    end do

  end subroutine io_dev_init_fields_alg

end module io_dev_init_fields_alg_mod
