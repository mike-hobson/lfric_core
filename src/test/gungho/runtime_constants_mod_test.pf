!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

module runtime_constants_mod_test
  implicit none

  contains

    @test
    subroutine runtime_constants_test()
      use constants_mod,            only : r_def, PLANE_BI_PERIODIC, GRAVITY
      use runtime_constants_mod,    only : runtime_constants_type
      use function_space_mod,       only : function_space_type, W0, W1, W2
      use mesh_mod,                 only : mesh_type
      use function_space_build_mod, only : fs_build, fs_destroy
      use operator_mod,             only : operator_type 
      use field_mod,                only : field_type, field_proxy_type   
      use pFUnit_Mod
     
      implicit none
      type( runtime_constants_type ) :: rt_const      
      type( function_space_type )    :: fs
      type (mesh_type)               :: mesh
      type( operator_type )          :: mm_w2, mm_w1, mm_w0
      type(field_type)               :: chi(3), geo
      type(field_proxy_type )        :: chi_p(3), geo_p, tmp_p
      integer :: i, j, k, cell
      real(kind=r_def), parameter :: DX = 6000.0_r_def, &
                                     DY = 1000.0_r_def, &
                                     DZ = 2000.0_r_def
      type(mesh_type), pointer     :: mesh_ptr => null()
      type(operator_type), pointer :: mm_w2_ptr, mm_w1_ptr, mm_w0_ptr =>null()
      type(field_type), pointer    :: chi_ptr(:), geo_ptr => null()
      real(kind=r_def), parameter  :: TOL = 1.0e-12_r_def
      integer, pointer             :: map_w0(:) => null()
      ! Dummy mesh mod has 9 cells, 3 layers
      mesh = mesh_type(PLANE_BI_PERIODIC)    

      ! build some function spaces
      call fs_build(mesh)

      ! build some function spaces ...
      call fs_build(mesh)
    
      ! make a coordinate field with a function space
      do i = 1,3
        chi(i) = field_type( vector_space = fs%get_instance( mesh, W0 ) )
        chi_p(i) = chi(i)%get_proxy()
      end do
      geo = field_type( vector_space = fs%get_instance( mesh, W0 ) )
      geo_p = geo%get_proxy()

      ! Compute coordinates
      cell = 1
      do j = 1,3
        do i = 1,3
          map_w0 => chi_p(1)%vspace%get_cell_dofmap( cell )
          do k = 0,3          
            chi_p(1)%data(map_w0(1) + k) = real(i-1)*DX
            chi_p(2)%data(map_w0(1) + k) = real(j-1)*DY
            chi_p(3)%data(map_w0(1) + k) = real(k)  *DZ
            geo_p   %data(map_w0(1) + k) = real(k)  *DZ*GRAVITY
          end do
          cell = cell + 1
        end do
      end do
      ! Create operators
      mm_w0 = operator_type(fs%get_instance(mesh, W0),fs%get_instance(mesh, W0))
      mm_w1 = operator_type(fs%get_instance(mesh, W1),fs%get_instance(mesh, W1))
      mm_w2 = operator_type(fs%get_instance(mesh, W2),fs%get_instance(mesh, W2))

      ! make the runtime_constants object
      rt_const = runtime_constants_type( mesh, chi, geo, mm_w0, mm_w1, mm_w2)

      ! check we get back what we sowed
      mesh_ptr  => rt_const%get_mesh()
      chi_ptr   => rt_const%get_coordinates()
      geo_ptr   => rt_const%get_geopotential()
      mm_w0_ptr => rt_const%get_mass_matrix(0)
      mm_w1_ptr => rt_const%get_mass_matrix(1)
      mm_w2_ptr => rt_const%get_mass_matrix(2)

      ! Some simple tests to check we have the same information
      @assertEqual( mesh_ptr%get_ncells(), mesh%get_ncells() )
      do i = 1, 3
        tmp_p = chi_ptr(i)%get_proxy()
        @assertEqual( tmp_p%data(:), chi_p(i)%data(:), TOL )
      end do
      tmp_p = geo_ptr%get_proxy()
      @assertEqual( tmp_p%data(:), geo_p%data(:), TOL )
      @assertEqual( mm_w0_ptr%which_fs_from(), mm_w0_ptr%which_fs_from() )
      @assertEqual( mm_w1_ptr%which_fs_from(), mm_w1_ptr%which_fs_from() )
      @assertEqual( mm_w2_ptr%which_fs_from(), mm_w2_ptr%which_fs_from() )

      ! tear down
      call fs_destroy()

    end  subroutine runtime_constants_test
end module runtime_constants_mod_test
