!-----------------------------------------------------------------------------
! (c) Crown copyright 2021 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> test the double non-spatial kernel
!>
!-------------------------------------------------------------------------------
module double_non_spatial_kernel_mod_test

    ! Global use statements go here

    use constants_mod, only : r_def, i_def

    use pFUnit_Mod

    implicit none

    private
    public :: double_non_spatial_kernel_test

    ! The test case type, containing procedures to setup, run
    ! and clean up after a test.
    ! It can also contain data.

    @TestCase
    type, extends(TestCase), public :: double_non_spatial_kernel_mod_test_type
        private
    contains
        procedure setUp
        procedure tearDown
        procedure double_non_spatial_kernel_test
    end type double_non_spatial_kernel_mod_test_type


contains

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !> The setUp subroutine is optional and is called prior to running the test.
    !> It is used to create and initialise types / data that are used in
    !> the tests
    subroutine setUp(this)

        implicit none

        class(double_non_spatial_kernel_mod_test_type), intent(inout) :: this

        ! This section should create and initialise anything needed for the test

    end subroutine setUp

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !> The tearDown subroutine is optional and called after the test.
    !> It is used to destroy any types / data previously created by setUp()
    subroutine tearDown(this)

        implicit none

        class(double_non_spatial_kernel_mod_test_type), intent(inout) :: this

        ! This section should destroy any previously created types / data

    end subroutine tearDown

    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ! pfUnit will run each subroutine preceded by the @test line
    @test
    subroutine double_non_spatial_kernel_test(this)

        ! This section is where the code for a self-contained test should be put

        use double_non_spatial_kernel_mod, only : double_non_spatial_code

        implicit none

        class(double_non_spatial_kernel_mod_test_type), intent(inout) :: this
        integer(kind = i_def) :: dof = 2 ! can be changed but update dimensions below
        integer(kind = i_def) :: layers = 2
        integer(kind = i_def) :: ndata_1 = 3
        integer(kind = i_def) :: ndata_2 = 2
        integer(kind = i_def) :: i, j, k, l
        integer(kind = i_def) :: counter = 1
        integer(kind = i_def), dimension(2) :: field_dof_map ! dof
        real(kind = r_def) :: tol
        real(kind = r_def), dimension(24) :: field ! dof * layers * ndata_1 * ndata_2

        field = 0.0_r_def

        ! Build up the dof map
        do i = 1, dof
            field_dof_map(i) = counter
            counter = counter + layers*ndata_1*ndata_2 ! advance the counter ready for the next column
        end do

        ! Do it!
        call double_non_spatial_code(layers, & !set
                field, & !calculated
                ndata_1, & !set
                ndata_2, & !set
                dof, & !set
                dof * layers * ndata_1 * ndata_2, & !set
                field_dof_map) !calculated

        tol = 1.0e-14_r_def

        ! Loop through the field
        do i = 1, dof
            do j = 1, ndata_2
                do k = 1, ndata_1
                    do l = 1, layers
                        ! check the field is equal to 10*ndata_2 + ndata_1
                        @assertEqual(10*j + k, field(field_dof_map( i ) + (j-1)*ndata_1*layers + (k-1)*layers + (l-1) ), tol)
                    end do
                end do
            end do
        end do

    end subroutine double_non_spatial_kernel_test

end module double_non_spatial_kernel_mod_test
