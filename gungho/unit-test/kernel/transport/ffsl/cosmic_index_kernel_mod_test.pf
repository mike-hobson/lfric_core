!-----------------------------------------------------------------------------
! (c) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> @brief Test the cosmic_index_kernel

module cosmic_index_kernel_mod_test

  use constants_mod,                  only: i_def, r_def, r_tran

  implicit none

contains

  !------------------------------------------------------------------

  @test
  subroutine cosmic_index_kernel_test()
    use pFUnit_Mod
    use, intrinsic :: iso_fortran_env,  only: real64
    use cosmic_index_kernel_mod,        only: cosmic_index_code

    implicit none

    real(kind=r_tran) :: tol
    integer(kind=i_def), parameter :: nlayers = 1
    integer(kind=i_def), parameter :: ndf_wp = 1
    integer(kind=i_def), parameter :: stencil_size = 3
    integer(kind=i_def), parameter :: stencil_size_x = stencil_size
    integer(kind=i_def), parameter :: stencil_size_y = stencil_size
    integer(kind=i_def), parameter :: undf_wps = ndf_wp*nlayers*stencil_size
    integer(kind=i_def), parameter :: undf_wp  = ndf_wp

    integer(kind=i_def), dimension(ndf_wp)              :: map_wp
    integer(kind=i_def), dimension(ndf_wp,stencil_size) :: stencil_map_x
    integer(kind=i_def), dimension(ndf_wp,stencil_size) :: stencil_map_y

    real(kind=r_def),    dimension(undf_wps) :: panel_id_x
    real(kind=r_def),    dimension(undf_wps) :: panel_id_y
    integer(kind=i_def), dimension(undf_wp)  :: ix_start
    integer(kind=i_def), dimension(undf_wp)  :: ix_end
    integer(kind=i_def), dimension(undf_wp)  :: iy_start
    integer(kind=i_def), dimension(undf_wp)  :: iy_end

    ! Set tolerance
    if ( r_tran == real64 ) then
      tol = 1.0e-12_r_tran
    else
      tol = 1.0e-6_r_tran
    end if

    ! Set maps
    map_wp(1) = 1
    stencil_map_x(1,:) = (/2_i_def, 1_i_def, 3_i_def /)
    stencil_map_y(1,:) = (/2_i_def, 1_i_def, 3_i_def /)

    ! Set up on same panel
    panel_id_x = (/1.0_r_def, 1.0_r_def, 1.0_r_def /)
    panel_id_y = (/1.0_r_def, 1.0_r_def, 1.0_r_def /)

    call cosmic_index_code( nlayers,        &
                            ix_start,       &
                            ix_end,         &
                            iy_start,       &
                            iy_end,         &
                            panel_id_x,     &
                            stencil_size_x, &
                            stencil_map_x,  &
                            panel_id_y,     &
                            stencil_size_y, &
                            stencil_map_y,  &
                            ndf_wp,         &
                            undf_wps,       &
                            map_wp )

    ! Test the indices are -1 and -2 (i.e. same panel)
    @assertEqual(-1.0_r_tran, real(ix_start,r_tran), tol)
    @assertEqual(-2.0_r_tran, real(ix_end,r_tran), tol)
    @assertEqual(-1.0_r_tran, real(iy_start,r_tran), tol)
    @assertEqual(-2.0_r_tran, real(iy_end,r_tran), tol)

    ! Set up on different panel
    panel_id_x = (/2.0_r_def, 2.0_r_def, 3.0_r_def /)
    panel_id_y = (/6.0_r_def, 1.0_r_def, 1.0_r_def /)

    call cosmic_index_code( nlayers,        &
                            ix_start,       &
                            ix_end,         &
                            iy_start,       &
                            iy_end,         &
                            panel_id_x,     &
                            stencil_size_x, &
                            stencil_map_x,  &
                            panel_id_y,     &
                            stencil_size_y, &
                            stencil_map_y,  &
                            ndf_wp,         &
                            undf_wps,       &
                            map_wp )

    ! Test the indices
    @assertEqual(1.0_r_tran, real(ix_start,r_tran), tol)
    @assertEqual(1.0_r_tran, real(ix_end,r_tran), tol)
    @assertEqual(3.0_r_tran, real(iy_start,r_tran), tol)
    @assertEqual(3.0_r_tran, real(iy_end,r_tran), tol)

  end subroutine cosmic_index_kernel_test

end module cosmic_index_kernel_mod_test